⏺ DreamPath 화상통화 구현 정리

  기술 스택

  - LiveKit (WebRTC 기반 오픈소스 화상통화 플랫폼)
  - OpenVidu (LiveKit 위에 구축된 Docker 배포판)
  - Spring Boot (백엔드 - 토큰 생성, 방 목록 API)
  - React + TypeScript (프론트엔드)

  ---
  구현된 기능

  1. 멘토링 로비 (/mentoring)

  - 현재 진행 중인 방 목록 표시 (5초 자동 갱신)
  - 방 생성 (방 이름 입력, 참가자 이름은 로그인 정보 자동 사용)
  - 방 참가 (클릭 한 번으로 입장)
  - 로그인 필수 (비로그인 시 로그인 페이지로 리다이렉트)

  2. 화상통화 (/mentoring/room)

  - 비디오/오디오 송수신
  - 카메라/마이크 토글
  - 실시간 채팅
  - 디스코드 스타일 음성 활동 표시 (말할 때 초록색 테두리)
  - 통화 종료 시 로비로 이동
  - 빈 방 자동 삭제 (참가자 0명이면 목록에서 제거)

  3. 백엔드 API

  - POST /api/video/token - LiveKit 접속 토큰 생성
  - GET /api/video/rooms - 현재 방 목록 조회 (LiveKit RoomServiceClient 사용)

  ---
  구현 로직

  화상통화 연결 흐름

  1. 사용자가 방 입장 요청
  2. 백엔드에서 LiveKit 토큰 생성 (JWT)
  3. 프론트엔드에서 LiveKit Room 객체 생성
  4. room.connect(wsUrl, token) 호출
  5. enableCameraAndMicrophone()로 미디어 트랙 발행
  6. TrackSubscribed 이벤트로 원격 트랙 구독
  7. RemoteTrack.attach()로 비디오 엘리먼트에 연결

  핵심 코드 구조

  // Room 생성
  const newRoom = new Room({
    adaptiveStream: true,
    dynacast: true,
  });

  // 연결
  await newRoom.connect(wsUrl, token, { autoSubscribe: true });

  // 미디어 발행
  await newRoom.localParticipant.enableCameraAndMicrophone();

  // 원격 트랙 구독
  newRoom.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
    if (track.kind === Track.Kind.Video) {
      track.attach(videoElement); // LiveKit attach() 메서드 사용
    }
  });

  // 음성 활동 감지
  newRoom.on(RoomEvent.ActiveSpeakersChanged, (speakers) => {
    setIsLocalSpeaking(speakers.some(s => s.identity === localIdentity));
  });

  ---
  발생한 문제점 & 해결 방법

  1. WebRTC Peer Connection 실패 (JOIN_FAILURE)

  문제: Docker 컨테이너가 내부 IP를 ICE candidate로 사용
  해결:
  - livekit.yaml에서 node_ip를 호스트 실제 IP(192.168.123.100)로 설정
  - Docker 포트 직접 노출 (7882:7880)

  2. 원격 비디오가 안 보임

  문제: adaptivestream video visibility = false로 비디오 비활성화
  원인: MediaStreamTrack을 직접 사용해서 LiveKit이 가시성 추적 못함
  해결: RemoteTrack.attach() 메서드 사용으로 변경

  3. 뒤늦게 들어온 사람이 상대방 비디오 못 봄

  문제: TrackSubscribed 이벤트가 connect() 완료 전에 발생, 이때 비디오 엘리먼트가 DOM에 없음
  해결: useEffect 의존성에 showJoinForm 추가하여 DOM 마운트 후 재실행

  4. 카메라 토글 시 로컬 비디오 멈춤

  문제: setCameraEnabled()가 새 트랙을 생성하지만 상태 업데이트 안됨
  해결:
  - toggleVideo를 async로 변경
  - setCameraEnabled() 후 새 트랙 직접 가져오기
  - isVideoEnabled false일 때 "카메라 꺼짐" placeholder 표시

  5. Git 서브모듈 문제

  문제: openvidu-local-deployment 폴더가 GitHub에서 화살표로 표시되고 접근 불가
  원인: 폴더 내 .git 폴더 존재 (git clone으로 받은 폴더)
  해결: .git 폴더 삭제 후 재커밋

  ---
  폴더 구조

  frontend/src/pages/mentoring/
  ├── page.tsx          # 멘토링 로비
  ├── room.tsx          # 화상통화 방
  └── components/
      ├── VideoControls.tsx
      ├── ChatPanel.tsx
      └── VideoDisplay.tsx

  backend/src/main/java/com/dreampath/
  ├── controller/VideoController.java  # API 엔드포인트
  ├── service/LiveKitService.java      # 토큰 생성, 방 목록 조회
  └── dto/TokenRequest.java, TokenResponse.java

  openvidu-local-deployment/community/
  ├── .env.example      # 환경 변수 템플릿 (한국어 설명)
  ├── livekit.yaml      # LiveKit 설정 (node_ip 수정 필요)
  ├── docker-compose.yaml
  └── README.md         # DreamPath 설정 가이드 추가

  ---
  팀원 설정 가이드 (요약)

  # 1. 환경 변수 복사
  cd openvidu-local-deployment/community
  cp .env.example .env

  # 2. 본인 IP 설정 (.env, livekit.yaml)
  LAN_PRIVATE_IP=본인IP
  node_ip: 본인IP

  # 3. 프론트엔드 환경 변수
  # frontend/.env.local
  VITE_LIVEKIT_URL=ws://본인IP:7882

  # 4. 실행
  docker compose up -d  # OpenVidu
  ./gradlew bootRun     # 백엔드
  npm run dev           # 프론트엔드

  ---
  향후 작업 가능 항목

  - 화면 공유 기능
  - 실제 JWT 토큰 인증 강화
  - 멘토/멘티 역할 구분
  - 멘토링 예약 시스템
  - 반응형 디자인 개선
  - API URL 동적 설정 (window.location.hostname 사용)